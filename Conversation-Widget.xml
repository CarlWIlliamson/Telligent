<scriptedContentFragments>
	<scriptedContentFragment name="${resource:Messages_Conversation_Name}" version="10.1.8.10498" description="${resource:Messages_Conversation_Description}" instanceIdentifier="8538372024974499938a88ac77596dfd" theme="" isCacheable="false" varyCacheByUser="true" showHeaderByDefault="false" cssClass="conversation">
		<contentScript><![CDATA[
#set($accessingUser = $core_v2_user.Accessing)
#if(!$core_v2_user.IsRegistered($accessingUser.Id))
    $core_v2_widget.Hide()
#end

#set ($messageListId = $core_v2_widget.UniqueId('MessageList'))
#set ($replyId = $core_v2_widget.UniqueId('Reply'))

$!core_v2_page.RedirectToHashedQuery()

<div class="message norecords">$core_v2_language.GetResource('NoConversations')</div>

<ul class="content-list content simple margin-bottom messages" id="$core_v2_encoding.HtmlAttributeEncode($messageListId)">
    <li class="content-item reply-form">
        <fieldset class="reply">
            <ul class="field-list reply">
                <li class="field-item reply body">
                    <label for="$core_v2_encoding.HtmlAttributeEncode($replyId)" class="field-item-name hidden">$core_v2_language.GetResource('ReplyPlaceholder')</label>
                    <span class="field-item-input reply">
                        #set ($body = '')
                        $core_v2_editor.Render('Reply', "%{Width='100%', Height='50px', Value=$body, ContentTypeId=$core_v2_conversationMessage.ContentTypeId.ToString() }")
                    </span>
                </li>
                <li class="field-item reply post-submit">
                    <span class="field-item-input reply">
                        <a href="#" class="internal-link add-reply button reply">$core_v2_language.GetResource('Reply')</a>
                        <span class="processing" style="visibility: hidden;"><span class="ui-loading" data-width="45" data-height="15"></span></span>
                    </span>
                </li>
            </ul>
        </fieldset>
    </li>
</ul>

#registerEndOfPageHtml('telligent.evolution.widgets.conversation')
    <script src="$core_v2_encoding.HtmlAttributeEncode($core_v2_widget.GetFileUrl('ui.js'))"></script>
#end
#registerEndOfPageHtml()
    <script>
    jQuery(function() {
        jQuery.telligent.evolution.widgets.conversation.register({
            messageList: '#$core_v2_encoding.JavascriptEncode($messageListId)',
            messageListUrl: '$core_v2_encoding.JavascriptEncode($core_v2_widget.GetExecutedFileUrl('messages-page.vm'))',
            conversationNotificationTypeId: '$core_v2_conversationMessage.NotificationTypeId',
            messageReplyContent: function() { return $core_v2_editor.GetContentScript('Reply'); },
            messageReplyFocus: function() { $core_v2_editor.GetFocusScript('Reply'); },
            messageReplyClear: function() {
                // when updating the content script, requires a name of a global variable that contains the content
                window.messageReplyCleared = '';
                $core_v2_editor.GetUpdateContentScript('Reply','messageReplyCleared');
            }
        });
    });
    </script>
#end
        ]]></contentScript>
		<headerScript><![CDATA[
$core_v2_widget.ApplyTokens($core_v2_widget.GetStringValue('fragmentHeader', '${resource:Messages_Conversation_Name}'))
    ]]></headerScript>
		<configuration><![CDATA[
<propertyGroup id="options" resourceName="Options">
    <property id="fragmentHeader" resourceName="CF_Title" dataType="string" defaultValue="${resource:Messages_Conversation_Name}" controlType="Telligent.Evolution.Controls.ContentFragmentTokenStringControl, Telligent.Evolution.Platform" />
</propertyGroup>
      ]]></configuration>
		<languageResources><language key="en-us">
  <resource name="Messages_Conversation_Name">Conversation</resource>
  <resource name="Messages_Conversation_Description">Displays a single conversation.</resource>
  <resource name="Options">Options</resource>
  <resource name="CF_Title">Widget Title</resource>
  <resource name="ReplyPlaceholder">Reply to this Conversation</resource>
  <resource name="Reply">Reply</resource>
  <resource name="ConversationStarted">Conversation started</resource>
  <resource name="NoConversations">There are no conversations to show.</resource>
</language>
<language key="zh-cn">
  <resource name="Messages_Conversation_Name">对话</resource>
  <resource name="Messages_Conversation_Description">显示一个对话。</resource>
  <resource name="Options">选项</resource>
  <resource name="CF_Title">小组件标题</resource>
  <resource name="ReplyPlaceholder">回复此对话</resource>
  <resource name="Reply">回复</resource>
  <resource name="ConversationStarted">已开始对话</resource>
  <resource name="NoConversations">没有可显示的对话。</resource>
</language>
<language key="zh-tw">
  <resource name="Messages_Conversation_Name">交談</resource>
  <resource name="Messages_Conversation_Description">顯示單一交談。</resource>
  <resource name="Options">選項</resource>
  <resource name="CF_Title">Widget 標題</resource>
  <resource name="ReplyPlaceholder">回覆此交談</resource>
  <resource name="Reply">回覆</resource>
  <resource name="ConversationStarted">交談已開始</resource>
  <resource name="NoConversations">沒有交談可顯示。</resource>
</language></languageResources>
		<requiredContext>
			<context id="fdf895d93a38459687e568b28de6d5b4" />
		</requiredContext>
		<files>
			<file name="messages.vm">77u/I3NldCAoJHBhZ2VTaXplID0gMTApDQokY29yZV92Ml9jb252ZXJzYXRpb24uTWFya0FzUmVhZCgkY29udmVyc2F0aW9uSWQpDQoNCiMjIHBhZ2luZyBvZiBjb252ZXJzYXRpb24gbWVzc2FnZXMgaXMgcmV2ZXJzZWQNCiMjIChyZXF1ZXN0aW5nIDAgcmV0dXJucyB0aGUgbGFzdCBwb3NzaWJsZSBwYWdlLCAxIHRoZSBzZWNvbmQgdG8gbGFzdCBwb3NzaWJsZSBwYWdlKQ0KDQojc2V0ICgkc3ViamVjdCA9IGZhbHNlKQ0KI3NldCAoJGN1cnJlbnRDb252ZXJzYXRpb24gPSAkY29yZV92Ml9jb252ZXJzYXRpb24uR2V0KCRjb252ZXJzYXRpb25JZCkpDQojaWYgKCRjdXJyZW50Q29udmVyc2F0aW9uICYmICRjdXJyZW50Q29udmVyc2F0aW9uLkZpcnN0TWVzc2FnZSkNCiAgICAjc2V0ICgkc3ViamVjdCA9ICRjdXJyZW50Q29udmVyc2F0aW9uLkZpcnN0TWVzc2FnZS5TdWJqZWN0KQ0KI2VuZA0KDQojIyBmaXJzdCBkZXRlcm1pbmUgdGhlIGluZGV4IG9mIHRoZSBsYXN0IHBhZ2Ugb2YgbWVzc2FnZXMNCiNzZXQgKCR0b3RhbENvdW50ID0gMCkNCiNzZXQgKCR0b3RhbENvdW50ID0gJGNvcmVfdjJfY29udmVyc2F0aW9uTWVzc2FnZS5MaXN0KCRjb252ZXJzYXRpb25JZCwgIiV7UGFnZUluZGV4ID0gMCwgUGFnZVNpemUgPSAxfSIpLlRvdGFsQ291bnQpDQojc2V0ICgkcmVtYWluZGVyID0gJHRvdGFsQ291bnQgJSAkcGFnZVNpemUpDQojaWYgKCRyZW1haW5kZXIgPiAwKQ0KICAgICNzZXQgKCRsYXN0UGFnZUluZGV4ID0gKCR0b3RhbENvdW50IC8gJHBhZ2VTaXplKSkNCiNlbHNlDQogICAgI3NldCAoJGxhc3RQYWdlSW5kZXggPSAoJHRvdGFsQ291bnQgLyAkcGFnZVNpemUpIC0gMSkNCiNlbmQNCg0KIyMgdGhlbiBjcmVhdGUgYSB1c2FibGUgcGFnZWluZGV4IGJhc2VkIG9uIGRpc3RhbmNlIGZyb20gdGhlIGxhc3QgcGFnZQ0KI3NldCAoJHBhZ2VJbmRleCA9ICRsYXN0UGFnZUluZGV4IC0gJHBhZ2VJbmRleCkNCiNpZiAoJHBhZ2VJbmRleCA8IDApDQogICAgI3NldCAoJHBhZ2VJbmRleCA9IDApDQojZW5kDQoNCiMjIGdldCBtZXNzYWdlcw0KI3NldCAoJG1lc3NhZ2VzID0gJGNvcmVfdjJfY29udmVyc2F0aW9uTWVzc2FnZS5MaXN0KCRjb252ZXJzYXRpb25JZCwgIiV7IFBhZ2VJbmRleCA9ICRwYWdlSW5kZXgsIFBhZ2VTaXplID0gJHBhZ2VTaXplIH0iKSkNCg0KIyMgdGhlcmUgYXJlIG1vcmUgcGFnZXMgeWV0IHRvIGJlIHBhZ2VkIGlmIHRoZSBhY3R1YWwgcGFnZSBpbmRleCB3YXMgc3RpbGwgPiAwDQojc2V0ICgkaGFzTW9yZSA9IGZhbHNlKQ0KI2lmICgkcGFnZUluZGV4ID4gMCkNCiAgICAjc2V0ICgkaGFzTW9yZSA9IHRydWUpDQojZW5kDQojc2V0ICgkaGFzTW9yZSA9ICRwYWdlSW5kZXggPiAwKQ0KDQojc2V0ICgkbGFzdERhdGUgPSBmYWxzZSkNCiNzZXQgKCRzdGFydGVkRmxhZyA9IGZhbHNlKQ0KI2lmICgkcGFnZUluZGV4ID4gMCkNCiAgICAjc2V0ICgkc3RhcnRlZEZsYWcgPSB0cnVlKQ0KI2VuZA0KDQojZm9yZWFjaCAoJG1lc3NhZ2UgaW4gJG1lc3NhZ2VzKQ0KICAgICNzZXQgKCRmb3JtYXR0ZWREYXRlID0gJGNvcmVfdjJfbGFuZ3VhZ2UuRm9ybWF0RGF0ZSgkbWVzc2FnZS5DcmVhdGVkRGF0ZSkpDQogICAgI2lmICgkbGFzdERhdGUgIT0gJGZvcm1hdHRlZERhdGUpDQogICAgICAgICNzZXQgKCRsYXN0RGF0ZSA9ICRjb3JlX3YyX2xhbmd1YWdlLkZvcm1hdERhdGUoJG1lc3NhZ2UuQ3JlYXRlZERhdGUpKQ0KICAgICAgICAjaWYgKCEkc3RhcnRlZEZsYWcpDQogICAgICAgICAgICAjc2V0ICgkc3RhcnRlZEZsYWcgPSB0cnVlKQ0KICAgICAgICAgICAgPGxpIGNsYXNzPSJjb250ZW50LWl0ZW0gZGF5IHN0YXJ0Ij4kY29yZV92Ml9sYW5ndWFnZS5HZXRSZXNvdXJjZSgnQ29udmVyc2F0aW9uU3RhcnRlZCcpICRsYXN0RGF0ZTwvbGk+DQogICAgICAgICNlbHNlDQogICAgICAgICAgICA8bGkgY2xhc3M9ImNvbnRlbnQtaXRlbSBkYXkiPiRsYXN0RGF0ZTwvbGk+DQogICAgICAgICNlbmQNCiAgICAjZW5kDQoNCiAgICAjc2V0ICgkaWQgPSAkY29yZV92Ml93aWRnZXQuVW5pcXVlSWQoImNvbnZlcnNhdGlvbi0ke21lc3NhZ2UuQ29udmVyc2F0aW9uSWR9LW1lc3NhZ2UtJHttZXNzYWdlLklkfSIpKQ0KICAgIDxsaSBjbGFzcz0iY29udGVudC1pdGVtIGNvbnZlcnNhdGlvbi1tZXNzYWdlIg0KICAgICAgICBpZD0iJGNvcmVfdjJfZW5jb2RpbmcuSHRtbEF0dHJpYnV0ZUVuY29kZSgkaWQpIg0KICAgICAgICBkYXRhLWNvbnZlcnNhdGlvbmlkPSIkIW1lc3NhZ2UuQ29udmVyc2F0aW9uSWQiDQogICAgICAgIGRhdGEtbWVzc2FnZWlkPSIkIW1lc3NhZ2UuSWQiDQogICAgICAgIGRhdGEtY3JlYXRlZGRhdGU9IiRjb3JlX3YyX2VuY29kaW5nLkh0bWxBdHRyaWJ1dGVFbmNvZGUoJCFjb3JlX3YyX2xhbmd1YWdlLkZvcm1hdERhdGUoJG1lc3NhZ2UuQ3JlYXRlZERhdGUpKSINCiAgICAgICAgZGF0YS1zdWJqZWN0PSIkY29yZV92Ml9lbmNvZGluZy5IdG1sQXR0cmlidXRlRW5jb2RlKCRjb3JlX3YyX2xhbmd1YWdlLlRydW5jYXRlKCRtZXNzYWdlLlN1YmplY3QsIDUwLCAiLi4uIikpIg0KICAgICAgICBkYXRhLWZ1bGxzdWJqZWN0PSIkY29yZV92Ml9lbmNvZGluZy5IdG1sQXR0cmlidXRlRW5jb2RlKCRtZXNzYWdlLlN1YmplY3QpIg0KICAgICAgICAjaWYoJGhhc01vcmUpIGRhdGEtaGFzbW9yZT0idHJ1ZSIgI2VuZD4NCg0KICAgICAgICA8ZGl2IGNsYXNzPSJjb250ZW50IGNvbW1lbnQiPg0KICAgICAgICAgICAgPGRpdiBjbGFzcz0iYXV0aG9yIj4NCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJhdmF0YXIiPg0KICAgICAgICAgICAgICAgICAgICAjaWYgKCRtZXNzYWdlLkF1dGhvci5Qcm9maWxlVXJsKQ0KICAgICAgICAgICAgICAgICAgICAgICAgPGEgaHJlZj0iJGNvcmVfdjJfZW5jb2RpbmcuSHRtbEF0dHJpYnV0ZUVuY29kZSgkbWVzc2FnZS5BdXRob3IuUHJvZmlsZVVybCkiIGNsYXNzPSJpbnRlcm5hbC1saW5rIHZpZXctdXNlci1wcm9maWxlIj4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkY29yZV92Ml91aS5HZXRSZXNpemVkSW1hZ2VIdG1sKCRtZXNzYWdlLkF1dGhvci5BdmF0YXJVcmwsIDQ0LCA0NCwgIiV7Ym9yZGVyPScwcHgnLCBhbHQ9JG1lc3NhZ2UuQXV0aG9yLkRpc3BsYXlOYW1lLCBSZXNpemVNZXRob2Q9J1pvb21BbmRDcm9wJ30iKQ0KICAgICAgICAgICAgICAgICAgICAgICAgPC9hPg0KICAgICAgICAgICAgICAgICAgICAjZWxzZQ0KICAgICAgICAgICAgICAgICAgICAgICAgJGNvcmVfdjJfdWkuR2V0UmVzaXplZEltYWdlSHRtbCgkbWVzc2FnZS5BdXRob3IuQXZhdGFyVXJsLCA0NCwgNDQsICIle2JvcmRlcj0nMHB4JywgYWx0PSRtZXNzYWdlLkF1dGhvci5EaXNwbGF5TmFtZSwgUmVzaXplTWV0aG9kPSdab29tQW5kQ3JvcCd9IikNCiAgICAgICAgICAgICAgICAgICAgI2VuZA0KICAgICAgICAgICAgICAgIDwvZGl2Pg0KICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJ1c2VyLW5hbWUiPg0KICAgICAgICAgICAgICAgICAgICAjaWYgKCRtZXNzYWdlLkF1dGhvci5Qcm9maWxlVXJsKQ0KICAgICAgICAgICAgICAgICAgICAgICAgPGEgaHJlZj0iJGNvcmVfdjJfZW5jb2RpbmcuSHRtbEF0dHJpYnV0ZUVuY29kZSgkbWVzc2FnZS5BdXRob3IuUHJvZmlsZVVybCkiIGNsYXNzPSJpbnRlcm5hbC1saW5rIHZpZXctdXNlci1wcm9maWxlIj4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbWVzc2FnZS5BdXRob3IuRGlzcGxheU5hbWUNCiAgICAgICAgICAgICAgICAgICAgICAgIDwvYT4NCiAgICAgICAgICAgICAgICAgICAgI2Vsc2UNCiAgICAgICAgICAgICAgICAgICAgICAgICRtZXNzYWdlLkF1dGhvci5EaXNwbGF5TmFtZQ0KICAgICAgICAgICAgICAgICAgICAjZW5kDQogICAgICAgICAgICAgICAgPC9zcGFuPg0KICAgICAgICAgICAgPC9kaXY+DQogICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb250ZW50Ij4kbWVzc2FnZS5SZW5kZXJlZEJvZHk8L2Rpdj4NCiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImF0dHJpYnV0ZXMiPg0KICAgICAgICAgICAgICAgIDx1bCBjbGFzcz0iYXR0cmlidXRlLWxpc3QiPg0KICAgICAgICAgICAgICAgICAgICA8bGkgY2xhc3M9ImF0dHJpYnV0ZS1pdGVtIj4NCiAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJhdHRyaWJ1dGUtdmFsdWUiPiRjb3JlX3YyX2xhbmd1YWdlLkZvcm1hdERhdGUoJG1lc3NhZ2UuQ3JlYXRlZERhdGUsICd0Jyk8L3NwYW4+DQogICAgICAgICAgICAgICAgICAgIDwvbGk+DQogICAgICAgICAgICAgICAgPC91bD4NCiAgICAgICAgICAgIDwvZGl2Pg0KICAgICAgICA8L2Rpdj4NCiAgICA8L2xpPg0KI2VuZA0KPHNwYW4gY2xhc3M9ImhpZGRlbiBtZXRhIiBkYXRhLXN1YmplY3Q9IiRjb3JlX3YyX2VuY29kaW5nLkh0bWxBdHRyaWJ1dGVFbmNvZGUoJHN1YmplY3QpIj48L3NwYW4+</file>
			<file name="messages-page.vm">77u/I3NldCAoJHBhZ2VJbmRleCA9IDApDQojc2V0ICgkcGFnZUluZGV4ID0gJGNvcmVfdjJfdXRpbGl0eS5QYXJzZUludCgkY29yZV92Ml9wYWdlLkdldFF1ZXJ5U3RyaW5nVmFsdWUoJ3BhZ2VJbmRleCcpKSkNCiNzZXQgKCRjb252ZXJzYXRpb25JZCA9IGZhbHNlKQ0KI3NldCAoJGNvbnZlcnNhdGlvbklkID0gJGNvcmVfdjJfdXRpbGl0eS5QYXJzZUd1aWQoJGNvcmVfdjJfcGFnZS5HZXRRdWVyeVN0cmluZ1ZhbHVlKCdjb252ZXJzYXRpb25JZCcpKSkNCiRjb3JlX3YyX3dpZGdldC5FeGVjdXRlRmlsZSgnbWVzc2FnZXMudm0nKQ==</file>
			<file name="ui.js">LyoNClB1Ymxpc2hlcyBtZXNzYWdlczoNCgl3aWRnZXRzLmNvbnZlcnNhdGlvbi5tZXNzYWdlQWRkZWQNCgkJY29udmVyc2F0aW9uSWQNCgl3aWRnZXRzLmNvbnZlcnNhdGlvbi5jb252ZXJzYXRpb25Mb2FkZWQNCgkJc3ViamVjdA0KCQljb252ZXJzYXRpb25JZA0KCXVpLm1lc3NhZ2VyZWFkIChwbGF0Zm9ybSBldmVudCkNCgkJY29udmVyc2F0aW9uSWQNClN1YnNjcmliZXMgdG8gbWVzc2FnZXM6DQoJd2lkZ2V0cy5jb252ZXJzYXRpb25MaXN0LmNvbnZlcnNhdGlvbnNMb2FkZWQNCgkJdG90YWxDb3VudA0KCXdpZGdldHMuY29udmVyc2F0aW9uTGlzdC5jb252ZXJzYXRpb25zRW1wdHkNCgl3aWRnZXRzLmNvbnZlcnNhdGlvbkJhbm5lci5jb252ZXJzYXRpb25EZWxldGVkDQoJCWNvbnZlcnNhdGlvbklkDQoJbm90aWZpY2F0aW9uLnJhaXNlZA0KCQl0eXBlSWQNCgljaGF0Lm1lc3NhZ2VSZWNlaXZlZCAocGxhdGZvcm0gZXZlbnQpDQogKi8NCihmdW5jdGlvbigkLCBnbG9iYWwsIHVuZGVmKXsNCg0KCSQudGVsbGlnZW50ID0gJC50ZWxsaWdlbnQgfHwge307DQoJJC50ZWxsaWdlbnQuZXZvbHV0aW9uID0gJC50ZWxsaWdlbnQuZXZvbHV0aW9uIHx8IHt9Ow0KCSQudGVsbGlnZW50LmV2b2x1dGlvbi53aWRnZXRzID0gJC50ZWxsaWdlbnQuZXZvbHV0aW9uLndpZGdldHMgfHwge307DQoNCgl2YXIgbWVzc2FnaW5nID0gJC50ZWxsaWdlbnQuZXZvbHV0aW9uLm1lc3NhZ2luZywNCiAgICAgICAgbWVzc2FnZXMgPSB7DQogICAgICAgICAgICAvLyBwdWJsaXNoZXMgZ2xvYmFsbHkNCgkJCW1lc3NhZ2VBZGRlZDogJ3dpZGdldHMuY29udmVyc2F0aW9uLm1lc3NhZ2VBZGRlZCcsDQoJCQljb252ZXJzYXRpb25Mb2FkZWQ6ICd3aWRnZXRzLmNvbnZlcnNhdGlvbi5jb252ZXJzYXRpb25Mb2FkZWQnLA0KCQkJdWlNZXNzYWdlUmVhZDogJ3VpLm1lc3NhZ2VyZWFkJywNCg0KCQkJLy8gc3Vic2NyaWJlcyBnbG9iYWxseQ0KCQkJY29udmVyc2F0aW9uc0xvYWRlZDogJ3dpZGdldHMuY29udmVyc2F0aW9uTGlzdC5jb252ZXJzYXRpb25zTG9hZGVkJywNCgkJCWNvbnZlcnNhdGlvbnNFbXB0eTogJ3dpZGdldHMuY29udmVyc2F0aW9uTGlzdC5jb252ZXJzYXRpb25zRW1wdHknLA0KCQkJY29udmVyc2F0aW9uRGVsZXRlZDogJ3dpZGdldHMuY29udmVyc2F0aW9uQmFubmVyLmNvbnZlcnNhdGlvbkRlbGV0ZWQnLA0KCQkJbm90aWZpY2F0aW9uUmFpc2VkOiAnbm90aWZpY2F0aW9uLnJhaXNlZCcsDQoJCQljaGF0TWVzc2FnZVJlY2VpdmVkOiAnY2hhdC5tZXNzYWdlUmVjZWl2ZWQnLA0KDQogICAgICAgICAgICAvLyBsb2NhbA0KICAgICAgICAgICAgY29udmVyc2F0aW9uUGFnZWQ6ICd3aWRnZXRzLmNvbnZlcnNhdGlvbi52aWV3LnBhZ2VkJywNCiAgICAgICAgICAgIGNvbnZlcnNhdGlvbkFkZFJlcGx5OiAnd2lkZ2V0cy5jb252ZXJzYXRpb24udmlldy5hZGRSZXBseScNCgkJfTsNCg0KICAgIC8qDQogICAgICogTW9kZWwNCiAgICAgKiBDb25zdHJ1Y3RvcjoNCiAgICAgKiAgIG1lc3NhZ2VMaXN0VXJsDQogICAgICogU3RhdGljOg0KICAgICAqICAgTW9kZWwubG9hZENvbnRleHR1YWwoY29udGV4dCwgc2hvdWxkQXBwZW5kKQ0KICAgICAqIE1ldGhvZHM6DQogICAgICogICBnZXQoY29udmVyc2F0aW9uSWQsIHBhZ2VJbmRleCkNCiAgICAgKiAgIHJlcGx5KGNvbnZlcnNhdGlvbklkLCBib2R5KQ0KICAgICAqIHB1Ymxpc2hlczoNCiAgICAgKiAgIHdpZGdldHMuY29udmVyc2F0aW9uLmNvbnZlcnNhdGlvbkxvYWRlZA0KICAgICAqLw0KICAgIGZ1bmN0aW9uIE1vZGVsKG9wdGlvbnMpIHsNCiAgICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsNCiAgICB9DQogICAgTW9kZWwubG9hZENvbnRleHR1YWwgPSBmdW5jdGlvbihjb250ZXh0LCBzaG91bGRBcHBlbmQpIHsNCiAgICAgICAgdmFyIGhhc2hkYXRhID0gJC50ZWxsaWdlbnQuZXZvbHV0aW9uLnVybC5oYXNoRGF0YSgpOw0KICAgICAgICB2YXIgY29udmVyc2F0aW9uSWQgPSBoYXNoZGF0YS5Db252ZXJzYXRpb25JRCB8fCBoYXNoZGF0YS5jb252ZXJzYXRpb25pZDsNCiAgICAgICAgaWYoY29udmVyc2F0aW9uSWQpIHsNCiAgICAgICAgICAgIGNvbnRleHQuY29udmVyc2F0aW9uSWQgPSBjb252ZXJzYXRpb25JZDsNCiAgICAgICAgICAgIGNvbnRleHQubW9kZWwuZ2V0KGNvbnZlcnNhdGlvbklkLCAwKS50aGVuKGZ1bmN0aW9uKHJlbmRlcmVkTWVzc2FnZXMpew0KICAgICAgICAgICAgICAgIGlmKHNob3VsZEFwcGVuZCkgew0KICAgICAgICAgICAgICAgICAgICBjb250ZXh0LnZpZXcuYXBwZW5kKGNvbnRleHQuY29udmVyc2F0aW9uSWQsIHJlbmRlcmVkTWVzc2FnZXMpOw0KICAgICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgICAgIGNvbnRleHQudmlldy5yZW5kZXIoY29udmVyc2F0aW9uSWQsIHJlbmRlcmVkTWVzc2FnZXMpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBtZXNzYWdpbmcucHVibGlzaChtZXNzYWdlcy51aU1lc3NhZ2VSZWFkLCB7DQogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNhdGlvbklkOiBjb252ZXJzYXRpb25JZA0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIE1vZGVsLnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbihjb252ZXJzYXRpb25JZCwgcGFnZUluZGV4KSB7DQogICAgICAgIHJldHVybiAkLnRlbGxpZ2VudC5ldm9sdXRpb24uZ2V0KHsNCiAgICAgICAgICAgIHVybDogdGhpcy5vcHRpb25zLm1lc3NhZ2VMaXN0VXJsLA0KICAgICAgICAgICAgZGF0YTogew0KICAgICAgICAgICAgICAgIGNvbnZlcnNhdGlvbklkOiBjb252ZXJzYXRpb25JZCwNCiAgICAgICAgICAgICAgICBwYWdlSW5kZXg6IHBhZ2VJbmRleCB8fCAwDQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgY2FjaGU6IGZhbHNlDQogICAgICAgIH0pLnBpcGUoZnVuY3Rpb24ocmVzcG9uc2Upew0KICAgICAgICAgICAgdmFyIHIgPSAkKHJlc3BvbnNlKTsNCiAgICAgICAgICAgIHZhciBtZXRhID0gci5maWx0ZXIoJy5oaWRkZW4ubWV0YScpLnJlbW92ZSgpOw0KICAgICAgICAgICAgaWYobWV0YSkgew0KICAgICAgICAgICAgICAgIG1lc3NhZ2luZy5wdWJsaXNoKG1lc3NhZ2VzLmNvbnZlcnNhdGlvbkxvYWRlZCwgew0KICAgICAgICAgICAgICAgICAgICBzdWJqZWN0OiBtZXRhLmRhdGEoJ3N1YmplY3QnKSwNCiAgICAgICAgICAgICAgICAgICAgY29udmVyc2F0aW9uSWQ6IGNvbnZlcnNhdGlvbklkDQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm4gcjsNCiAgICAgICAgfSk7DQogICAgfTsNCiAgICBNb2RlbC5wcm90b3R5cGUucmVwbHkgPSBmdW5jdGlvbihjb252ZXJzYXRpb25JZCwgYm9keSkgew0KICAgICAgICByZXR1cm4gJC50ZWxsaWdlbnQuZXZvbHV0aW9uLnBvc3Qoew0KICAgICAgICAgICAgdXJsOiAkLnRlbGxpZ2VudC5ldm9sdXRpb24uc2l0ZS5nZXRCYXNlVXJsKCkgKyAnYXBpLmFzaHgvdjIvY29udmVyc2F0aW9ucy97Q29udmVyc2F0aW9uSWR9L21lc3NhZ2VzLmpzb24nLA0KICAgICAgICAgICAgZGF0YTogew0KICAgICAgICAgICAgICAgIENvbnZlcnNhdGlvbklkOiBjb252ZXJzYXRpb25JZCwNCiAgICAgICAgICAgICAgICBCb2R5OiBib2R5DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgY2FjaGU6IGZhbHNlLA0KICAgICAgICB9KTsNCiAgICB9Ow0KDQoNCg0KICAgIC8qDQogICAgICogVmlldw0KICAgICAqIENvbnN0cnVjdG9yOg0KICAgICAqICAgdmlldw0KICAgICAqIEV2ZW50cw0KICAgICAqICAgd2lkZ2V0cy5jb252ZXJzYXRpb24udmlldy5wYWdlZCAocGFnZUluZGV4KQ0KICAgICAqICAgd2lkZ2V0cy5jb252ZXJzYXRpb24udmlldy5hZGRSZXBseSAgKGNvbnZlcnNhdGlvbklkLCBib2R5KQ0KICAgICAqIE1ldGhvZHMNCiAgICAgKiAgIHJlbmRlcihjb252ZXJzYXRpb25JZCwgcmVuZGVyZWRNZXNzYWdlcykNCiAgICAgKiAgIHByZXBlbmQoY29udmVyc2F0aW9uSWQsIHJlbmRlcmVkTWVzc2FnZXMpDQogICAgICogICBhcHBlbmQoY29udmVyc2F0aW9uSWQsIHJlbmRlcmVkTWVzc2FnZXMpDQogICAgICogICBoaWRlKCkNCiAgICAgKi8NCiAgICB2YXIgVmlldyA9IChmdW5jdGlvbigpew0KICAgICAgICB2YXIgZGVmYXVsdHMgPSB7DQogICAgICAgICAgICB2aWV3OiB7DQogICAgICAgICAgICAgICAgbGlzdDogJycsDQogICAgICAgICAgICAgICAgcmVwbHlMaW5rOiAnJywNCiAgICAgICAgICAgICAgICByZXBseUZvcm06ICcnLA0KICAgICAgICAgICAgfQ0KICAgICAgICB9Ow0KDQogICAgICAgIC8vIGRldGVybWluZSBpZiB0aGlzIGNvbnRlbnQgaXMgZW5vdWdoIHRvIGNhdXNlIHNjcm9sbGluZw0KICAgICAgICAvLyBpZiBub3QsIHRyeSBhc2tpbmcgZm9yIG1vcmUgcGFnZXMgdW50aWwgaXQgZG9lcyBvciBtYXggYXR0ZW1wdHMgcmVhY2hlZA0KICAgICAgICBmdW5jdGlvbiBwYWdlVW50aWxTY3JvbGxzKGNvbnRleHQpIHsNCiAgICAgICAgICAgIGlmKCFjb250ZXh0Lmhhc01vcmUpDQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgaWYoY29udGV4dC52aWV3Lmxpc3QuaGVpZ2h0KCkgPCBjb250ZXh0LmNvbnRhaW5lci5oZWlnaHQoKSAmJiBjb250ZXh0LnBhZ2VkQ29udGVudEF0dGVtcHRzIDwgMTApIHsNCiAgICAgICAgICAgICAgICBjb250ZXh0LnBhZ2VkQ29udGVudEF0dGVtcHRzKys7DQogICAgICAgICAgICAgICAgY29udGV4dC5wYWdlSW5kZXgrKzsNCiAgICAgICAgICAgICAgICBtZXNzYWdpbmcucHVibGlzaChtZXNzYWdlcy5jb252ZXJzYXRpb25QYWdlZCwgew0KICAgICAgICAgICAgICAgICAgICBwYWdlSW5kZXg6IGNvbnRleHQucGFnZUluZGV4LA0KICAgICAgICAgICAgICAgICAgICBjb252ZXJzYXRpb25JZDogY29udGV4dC5jb252ZXJzYXRpb25JZCwNCiAgICAgICAgICAgICAgICAgICAgc2Nyb2xsVG9Cb3R0b206IHRydWUNCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgY29udGV4dC5wYWdlZENvbnRlbnRBdHRlbXB0cyA9IDA7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBoYW5kbGVFdmVudHMoY29udGV4dCkgew0KICAgICAgICAgICAgLy8gYmxvY2sgc2Nyb2xsaW5nIG9mIG91dGVyIHNlY3Rpb25zDQogICAgICAgICAgICAvLyBibG9ja1Njcm9sbGluZ1doaWxlT3Zlcihjb250ZXh0LnZpZXcubGlzdCk7DQoNCiAgICAgICAgICAgIC8vIGluZmluaXRlIHBhZ2luZyB3aGVuIHNjcm9sbGluZyB1cA0KICAgICAgICAgICAgY29udGV4dC5jb250YWluZXIub24oJ3Njcm9sbHRvcCcsIGZ1bmN0aW9uKCl7DQogICAgICAgICAgICAgICAgaWYoIWNvbnRleHQuaGFzTW9yZSkNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgIGNvbnRleHQucGFnZUluZGV4Kys7DQogICAgICAgICAgICAgICAgbWVzc2FnaW5nLnB1Ymxpc2gobWVzc2FnZXMuY29udmVyc2F0aW9uUGFnZWQsIHsNCiAgICAgICAgICAgICAgICAgICAgcGFnZUluZGV4OiBjb250ZXh0LnBhZ2VJbmRleCwNCiAgICAgICAgICAgICAgICAgICAgY29udmVyc2F0aW9uSWQ6IGNvbnRleHQuY29udmVyc2F0aW9uSWQNCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICAvLyBjbGlja2luZyByZXBseSBsaW5rDQogICAgICAgICAgICBjb250ZXh0LnZpZXcucmVwbHlMaW5rLm9uKCdjbGljaycsIGZ1bmN0aW9uKGUpew0KICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsNCiAgICAgICAgICAgICAgICAvLyBnZXQgdGhlIGJvZHkNCiAgICAgICAgICAgICAgICB2YXIgYm9keSA9ICQudHJpbShjb250ZXh0Lm1lc3NhZ2VSZXBseUNvbnRlbnQoKSk7DQogICAgICAgICAgICAgICAgaWYoYm9keS5sZW5ndGggPT09IDApDQogICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICAvLyBhZGQgcmVwbHkNCiAgICAgICAgICAgICAgICBjb250ZXh0Lm1lc3NhZ2VSZXBseUNsZWFyKCk7DQogICAgICAgICAgICAgICAgbWVzc2FnaW5nLnB1Ymxpc2gobWVzc2FnZXMuY29udmVyc2F0aW9uQWRkUmVwbHksIHsNCiAgICAgICAgICAgICAgICAgICAgY29udmVyc2F0aW9uSWQ6IGNvbnRleHQuY29udmVyc2F0aW9uSWQsDQogICAgICAgICAgICAgICAgICAgIGJvZHk6IGJvZHkNCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICB9KTsNCiAgICAgICAgfQ0KDQogICAgICAgIHJldHVybiBmdW5jdGlvbihvcHRpb25zKSB7DQogICAgICAgICAgICB2YXIgY29udGV4dCA9ICQuZXh0ZW5kKHt9LCBkZWZhdWx0cywgb3B0aW9ucyB8fCB7fSksDQogICAgICAgICAgICAgICAgdmlld1dyYXBwZXIgPSAkKGNvbnRleHQudmlldyk7DQogICAgICAgICAgICBjb250ZXh0LnBhZ2VJbmRleCA9IDA7DQoNCiAgICAgICAgICAgIC8vIGNhcHR1cmUgdmlldyBwaWVjZXMNCiAgICAgICAgICAgIGNvbnRleHQudmlldyA9IHsNCiAgICAgICAgICAgICAgICB3cmFwcGVyOiB2aWV3V3JhcHBlci5jbG9zZXN0KCcuY29udGVudC1mcmFnbWVudCcpLA0KICAgICAgICAgICAgICAgIGxpc3Q6IHZpZXdXcmFwcGVyLA0KICAgICAgICAgICAgICAgIHJlcGx5TGluazogdmlld1dyYXBwZXIuZmluZCgnYS5hZGQtcmVwbHknKSwNCiAgICAgICAgICAgICAgICB1bnNlbGVjdGVkTWVzc2FnZTogdmlld1dyYXBwZXIuZmluZCgnLm5vZGF0YS5zZWxlY3QnKSwNCiAgICAgICAgICAgICAgICBub01lc3NhZ2VzOiB2aWV3V3JhcHBlci5wYXJlbnQoKS5maW5kKCcubWVzc2FnZS5ub3JlY29yZHMnKSwNCiAgICAgICAgICAgICAgICByZXBseUZvcm06IHZpZXdXcmFwcGVyLmZpbmQoJy5yZXBseS1mb3JtJyksDQogICAgICAgICAgICAgICAgcmVwbHlGb3JtRmllbGRzOiB2aWV3V3JhcHBlci5maW5kKCcuZmllbGQtbGlzdC5yZXBseScpDQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIC8vIHNldCB1cCBldmVudCBoYW5kbGVycw0KICAgICAgICAgICAgaGFuZGxlRXZlbnRzKGNvbnRleHQpOw0KDQogICAgICAgICAgICAvLyBzbWFsbCBoZWxwZXIgdG8gc2hvdyBjb252ZXJzYXRpb24tc3BlY2lmaWMgdWkgZWxlbWVudHMgZm9yIG1lc3NhZ2UgbGlzdCB2aWV3DQogICAgICAgICAgICBmdW5jdGlvbiBzaG93KCkgew0KICAgICAgICAgICAgICAgIGNvbnRleHQudmlldy51bnNlbGVjdGVkTWVzc2FnZS5oaWRlKCk7DQogICAgICAgICAgICAgICAgY29udGV4dC52aWV3Lm5vTWVzc2FnZXMuaGlkZSgpOw0KICAgICAgICAgICAgICAgIGNvbnRleHQudmlldy5saXN0LnNob3coKTsNCiAgICAgICAgICAgICAgICBjb250ZXh0LnZpZXcucmVwbHlGb3JtLnNob3coKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgLy8gc21hbGwgaGVscGVyIHRvIGhpZGUgY29udmVyc2F0aW9uLXNwZWNpZmljIHVpIGVsZW1lbnRzIGluIG1lc3NhZ2UgbGlzdCB2aWV3DQogICAgICAgICAgICBmdW5jdGlvbiBoaWRlKCkgew0KICAgICAgICAgICAgICAgIGNvbnRleHQudmlldy5saXN0LmhpZGUoKTsNCiAgICAgICAgICAgICAgICBjb250ZXh0LnZpZXcucmVwbHlGb3JtLmhpZGUoKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgZnVuY3Rpb24gZ2V0TWVzc2FnZXNIZWlnaHQoKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQudmlldy5saXN0Lm9mZnNldCgpLnRvcCArIGNvbnRleHQudmlldy5saXN0Lm91dGVySGVpZ2h0KHRydWUpDQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIHJldHVybiB7DQogICAgICAgICAgICAgICAgLy8gcmVwbGFjZXMgYWxsIHRoZSBjb250ZW50IG9mIHRoZSB2aWV3DQogICAgICAgICAgICAgICAgLy8gaWYgbm8gY29udGVudCBwYXNzZWQsIHJlLWluaXRpYXRlcyB3aXRoIHRoZSB2aWV3J3MgY3VycmVudCBjb250ZW50cw0KICAgICAgICAgICAgICAgIHJlbmRlcjogZnVuY3Rpb24oY29udmVyc2F0aW9uSWQsIHJlbmRlcmVkTWVzc2FnZXMpIHsNCiAgICAgICAgICAgICAgICAgICAgLy8gbWV0YQ0KICAgICAgICAgICAgICAgICAgICBjb250ZXh0LmNvbnZlcnNhdGlvbklkID0gY29udmVyc2F0aW9uSWQ7DQogICAgICAgICAgICAgICAgICAgIGNvbnRleHQucGFnZUluZGV4ID0gMDsNCiAgICAgICAgICAgICAgICAgICAgY29udGV4dC5oYXNNb3JlID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICAgICAgY29udGV4dC5wYWdlZENvbnRlbnRBdHRlbXB0cyA9IDA7DQogICAgICAgICAgICAgICAgICAgIC8vIGhpZGUgYW5kIHNob3cgcGFydHMgb2YgdGhlIHZpZXcNCiAgICAgICAgICAgICAgICAgICAgaWYoY29udmVyc2F0aW9uSWQpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHNob3coKTsNCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGhpZGUoKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgICAgIC8vIHJlbmRlciBtZXNzYWdlcw0KICAgICAgICAgICAgICAgICAgICBpZihyZW5kZXJlZE1lc3NhZ2VzKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAvL2NvbnRleHQudmlldy5saXN0Lmh0bWwocmVuZGVyZWRNZXNzYWdlcyk7DQogICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0LnZpZXcubGlzdC5maW5kKCdsaS5jb252ZXJzYXRpb24tbWVzc2FnZSxsaS5kYXknKS5yZW1vdmUoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQudmlldy5saXN0LnByZXBlbmQocmVuZGVyZWRNZXNzYWdlcyk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgdmFyIGZpcnN0TWVzc2FnZSA9IGNvbnRleHQudmlldy5saXN0LmZpbmQoJ2xpLmNvbnZlcnNhdGlvbi1tZXNzYWdlOmZpcnN0Jyk7DQogICAgICAgICAgICAgICAgICAgIGNvbnRleHQuaGFzTW9yZSA9IGZpcnN0TWVzc2FnZS5kYXRhKCdoYXNtb3JlJyk7DQoNCiAgICAgICAgICAgICAgICAgICAgcGFnZVVudGlsU2Nyb2xscyhjb250ZXh0KTsNCg0KICAgICAgICAgICAgICAgICAgICAvLyBrZWVwIHNjcm9sbGVkIGRvd24gb3IgcmV0YWluIGN1cnJlbnQgc2Nyb2xsIHBvc2l0aW9uDQogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQuY29udGFpbmVyLnNjcm9sbFRvcChnZXRNZXNzYWdlc0hlaWdodCgpKQ0KICAgICAgICAgICAgICAgICAgICB9LCA1MCk7DQoNCiAgICAgICAgICAgICAgICAgICAgY29udGV4dC5tZXNzYWdlUmVwbHlDbGVhcigpOw0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgcHJlcGVuZDogZnVuY3Rpb24oY29udmVyc2F0aW9uSWQsIHJlbmRlcmVkTWVzc2FnZXMsIHNjcm9sbFRvQm90dG9tKSB7DQogICAgICAgICAgICAgICAgICAgIGNvbnRleHQuY29udmVyc2F0aW9uSWQgPSBjb252ZXJzYXRpb25JZDsNCiAgICAgICAgICAgICAgICAgICAgdmFyIHZpZXdFbGVtZW50ID0gY29udGV4dC52aWV3Lmxpc3QuZ2V0KDApLA0KICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0SGVpZ2h0ID0gY29udGV4dC5jb250YWluZXIuc2Nyb2xsVG9wKCk7DQogICAgICAgICAgICAgICAgICAgIHJlbmRlcmVkTWVzc2FnZXMgPSAkKHJlbmRlcmVkTWVzc2FnZXMpLnRvQXJyYXkoKS5yZXZlcnNlKCk7DQogICAgICAgICAgICAgICAgICAgICQocmVuZGVyZWRNZXNzYWdlcykuZWFjaChmdW5jdGlvbihpKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIG9ubHkgYXBwZW5kIGNvbnZlcnNhdGlvbnMgdG8gdGhlIGxpc3Qgd2hpY2ggYXJlbid0IGFscmVhZHkgaW4gdGhlIGxpc3QNCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpZCA9IHRoaXMuaWQsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNEYXkgPSAkKHRoaXMpLmlzKCcuZGF5Jyk7DQogICAgICAgICAgICAgICAgICAgICAgICBpZihpc0RheSB8fCAoaWQgJiYgJCgnIycgKyBpZCkubGVuZ3RoID09PSAwKSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQudmlldy5saXN0LnByZXBlbmQodGhpcyk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0SGVpZ2h0ICs9ICQodGhpcykub3V0ZXJIZWlnaHQodHJ1ZSk7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgICAgICAvLyBrZWVwIHNjcm9sbGVkIGRvd24gb3IgcmV0YWluIGN1cnJlbnQgc2Nyb2xsIHBvc2l0aW9uDQogICAgICAgICAgICAgICAgICAgIGNvbnRleHQuY29udGFpbmVyLnNjcm9sbFRvcChzY3JvbGxUb0JvdHRvbSA/IGdldE1lc3NhZ2VzSGVpZ2h0KCkgOiBvZmZzZXRIZWlnaHQpDQoNCiAgICAgICAgICAgICAgICAgICAgY29udGV4dC5oYXNNb3JlID0gY29udGV4dC52aWV3Lmxpc3QuZmluZCgnbGkuY29udmVyc2F0aW9uLW1lc3NhZ2U6Zmlyc3QnKS5kYXRhKCdoYXNtb3JlJyk7DQoNCiAgICAgICAgICAgICAgICAgICAgcGFnZVVudGlsU2Nyb2xscyhjb250ZXh0KTsNCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgIGFwcGVuZDogZnVuY3Rpb24oY29udmVyc2F0aW9uSWQsIHJlbmRlcmVkTWVzc2FnZXMpIHsNCiAgICAgICAgICAgICAgICAgICAgY29udGV4dC5jb252ZXJzYXRpb25JZCA9IGNvbnZlcnNhdGlvbklkOw0KICAgICAgICAgICAgICAgICAgICB2YXIgdmlld0VsZW1lbnQgPSBjb250ZXh0LnZpZXcubGlzdC5nZXQoMCk7DQogICAgICAgICAgICAgICAgICAgICQocmVuZGVyZWRNZXNzYWdlcykuZWFjaChmdW5jdGlvbigpew0KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGlzRGF5ID0gJCh0aGlzKS5pcygnLmRheScpOw0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gb25seSBhcHBlbmQgY29udmVyc2F0aW9ucyB0byB0aGUgbGlzdCB3aGljaCBhcmVuJ3QgYWxyZWFkeSBpbiB0aGUgbGlzdA0KICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWlzRGF5ICYmICQoJyMnICsgdGhpcy5pZCkubGVuZ3RoID09PSAwKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dC52aWV3Lmxpc3QuZmluZCgnbGkucmVwbHktZm9ybScpLmJlZm9yZSh0aGlzKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBrZWVwIHNjcm9sbGVkIGRvd24NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0LmNvbnRhaW5lci5zY3JvbGxUb3AoZ2V0TWVzc2FnZXNIZWlnaHQoKSk7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgaGlkZTogZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgICAgIGhpZGUoKTsNCiAgICAgICAgICAgICAgICAgICAgY29udGV4dC5jb252ZXJzYXRpb25JZCA9IGZhbHNlOw0KICAgICAgICAgICAgICAgICAgICBjb250ZXh0LmNvbnZlcnNhdGlvbkxpc3QgPSBudWxsOw0KICAgICAgICAgICAgICAgICAgICBjb250ZXh0Lm1lc3NhZ2VSZXBseUNsZWFyKCk7DQogICAgICAgICAgICAgICAgfSwNCgkJCQlzaG93Tm9NZXNzYWdlczogZnVuY3Rpb24oKSB7DQoJCQkJCWNvbnRleHQudmlldy5ub01lc3NhZ2VzLnNob3coKTsNCgkJCQl9LA0KCQkJCWhpZGVOb01lc3NhZ2VzOiBmdW5jdGlvbigpIHsNCgkJCQkJY29udGV4dC52aWV3Lm5vTWVzc2FnZXMuaGlkZSgpOw0KCQkJCX0NCiAgICAgICAgICAgIH07DQogICAgICAgIH07DQogICAgfSkoKTsNCg0KDQogICAgLy8gVUkgYWRqdXN0bWVudCBoZWxwZXJzDQogICAgdmFyIHVpID0gew0KICAgICAgICBoaWRlRm9vdGVyOiBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICQoJy5mb290ZXItZnJhZ21lbnRzLWhlYWRlciwuZm9vdGVyLWZyYWdtZW50cywuZm9vdGVyLWZyYWdtZW50cy1mb290ZXInKS5jc3Moew0KICAgICAgICAgICAgICAgICdtaW4taGVpZ2h0JzogMCwNCiAgICAgICAgICAgICAgICAnaGVpZ2h0JzogMCwNCiAgICAgICAgICAgICAgICAnb3ZlcmZsb3cnOiAnaGlkZGVuJw0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0sDQogICAgICAgIHJlc2l6ZUxheW91dDogKGZ1bmN0aW9uKCl7DQogICAgICAgICAgICB2YXIgdG9NZWFzdXJlID0gbnVsbCwNCiAgICAgICAgICAgICAgICBwYWdlRnJhZ21lbnRzID0gbnVsbDsNCiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihjb250ZXh0KSB7DQogICAgICAgICAgICAgICAgdmFyIHRvdGFsID0gJCgnLmhlYWRlci1mcmFnbWVudHMnKS5vZmZzZXQoKS50b3A7DQogICAgICAgICAgICAgICAgdG9NZWFzdXJlID0gJCh0b01lYXN1cmUgfHwgJC5tYXAoWydoZWFkZXItZnJhZ21lbnRzLWhlYWRlcicsJ2hlYWRlci1mcmFnbWVudHMnLCdoZWFkZXItZnJhZ21lbnRzLWZvb3RlciddLCBmdW5jdGlvbihzZWwpew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gJCgnLicgKyBzZWwpOw0KICAgICAgICAgICAgICAgIH0pKS5lYWNoKGZ1bmN0aW9uKCl7DQogICAgICAgICAgICAgICAgICAgIHRvdGFsICs9ICQodGhpcykub3V0ZXJIZWlnaHQodHJ1ZSk7DQogICAgICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgICAgICAkKCcuY29udGVudC1mcmFnbWVudC5wYWdlJykuY3NzKHsgJ21pbi1oZWlnaHQnOiAoY29udGV4dC5jb250YWluZXIuaW5uZXJIZWlnaHQoKSAtIHRvdGFsKSB9KTsNCiAgICAgICAgICAgIH07DQogICAgICAgIH0pKCkNCiAgICB9DQoNCg0KICAgIC8vIG1lc3NhZ2luZw0KDQogICAgZnVuY3Rpb24gc3Vic2NyaWJlVG9NZXNzYWdlcyhjb250ZXh0KSB7DQogICAgICAgIC8vIG1lc3NhZ2UgbGlzdCBwYWdpbmcNCiAgICAgICAgbWVzc2FnaW5nLnN1YnNjcmliZShtZXNzYWdlcy5jb252ZXJzYXRpb25QYWdlZCwgZnVuY3Rpb24oZGF0YSkgew0KICAgICAgICAgICAgaWYoY29udGV4dC5sb2FkaW5nTWVzc2FnZXMpDQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgY29udGV4dC5sb2FkaW5nTWVzc2FnZXMgPSB0cnVlOw0KICAgICAgICAgICAgY29udGV4dC5tb2RlbC5nZXQoZGF0YS5jb252ZXJzYXRpb25JZCwgZGF0YS5wYWdlSW5kZXgpLnRoZW4oZnVuY3Rpb24ocGFnZUNvbnRlbnQpew0KICAgICAgICAgICAgICAgIGNvbnRleHQubG9hZGluZ01lc3NhZ2VzID0gZmFsc2U7DQogICAgICAgICAgICAgICAgY29udGV4dC52aWV3LnByZXBlbmQoZGF0YS5jb252ZXJzYXRpb25JZCwgcGFnZUNvbnRlbnQsIGRhdGEuc2Nyb2xsVG9Cb3R0b20gfHwgZGF0YS5wYWdlSW5kZXggPT09IDApOw0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0pOw0KDQogICAgICAgIC8vIGNvbnZlcnNhdGlvbiBkZWxldGluZw0KICAgICAgICBtZXNzYWdpbmcuc3Vic2NyaWJlKG1lc3NhZ2VzLmNvbnZlcnNhdGlvbkRlbGV0ZWQsIGZ1bmN0aW9uKGRhdGEpIHsNCiAgICAgICAgICAgIGNvbnRleHQudmlldy5oaWRlKCk7DQogICAgICAgICAgICBjb250ZXh0LmNvbnZlcnNhdGlvbklkID0gbnVsbDsNCiAgICAgICAgfSk7DQoNCiAgICAgICAgLy8gcmVwbHlpbmcgdG8gYSBjb252ZXJzYXRpb24NCiAgICAgICAgbWVzc2FnaW5nLnN1YnNjcmliZShtZXNzYWdlcy5jb252ZXJzYXRpb25BZGRSZXBseSwgZnVuY3Rpb24oZGF0YSkgew0KICAgICAgICAgICAgY29udGV4dC5tb2RlbC5yZXBseShkYXRhLmNvbnZlcnNhdGlvbklkLCBkYXRhLmJvZHkpLnRoZW4oZnVuY3Rpb24oKXsNCiAgICAgICAgICAgICAgICBtZXNzYWdpbmcucHVibGlzaChtZXNzYWdlcy5tZXNzYWdlQWRkZWQsIHsNCiAgICAgICAgICAgICAgICAgICAgY29udmVyc2F0aW9uSWQ6IGRhdGEuY29udmVyc2F0aW9uSWQNCiAgICAgICAgICAgICAgICB9KQ0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0pOw0KICAgICAgICBtZXNzYWdpbmcuc3Vic2NyaWJlKG1lc3NhZ2VzLm1lc3NhZ2VBZGRlZCwgZnVuY3Rpb24oZGF0YSkgew0KICAgICAgICAgICAgTW9kZWwubG9hZENvbnRleHR1YWwoY29udGV4dCwgdHJ1ZSk7DQogICAgICAgIH0pOw0KDQogICAgICAgIC8vIHJlY2VpdmluZyBhIGNvbnZlcnNhdGlvbiBub3RpZmljYXRpb24NCiAgICAgICAgbWVzc2FnaW5nLnN1YnNjcmliZShtZXNzYWdlcy5ub3RpZmljYXRpb25SYWlzZWQsIGZ1bmN0aW9uKGRhdGEpIHsNCiAgICAgICAgICAgIGlmKGRhdGEudHlwZUlkID09PSBjb250ZXh0LmNvbnZlcnNhdGlvbk5vdGlmaWNhdGlvblR5cGVJZCkgew0KICAgICAgICAgICAgICAgIE1vZGVsLmxvYWRDb250ZXh0dWFsKGNvbnRleHQsIHRydWUpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCg0KICAgICAgICAvLyByZWNlaXZpbmcgYSBjaGF0IG1lc3NhZ2UNCiAgICAgICAgbWVzc2FnaW5nLnN1YnNjcmliZShtZXNzYWdlcy5jaGF0TWVzc2FnZVJlY2VpdmVkLCBmdW5jdGlvbihkYXRhKXsNCiAgICAgICAgICAgIE1vZGVsLmxvYWRDb250ZXh0dWFsKGNvbnRleHQsIHRydWUpOw0KICAgICAgICB9KTsNCg0KCQkvLyBjb252ZXJzYXRpb25zIGxvYWRlZA0KCQltZXNzYWdpbmcuc3Vic2NyaWJlKG1lc3NhZ2VzLmNvbnZlcnNhdGlvbnNMb2FkZWQsIGZ1bmN0aW9uKGRhdGEpew0KCQkJaWYgKGRhdGEgJiYgZGF0YS50b3RhbENvdW50ID09IDApIHsNCgkJCQljb250ZXh0LnZpZXcuc2hvd05vTWVzc2FnZXMoKTsNCgkJCX0NCgkJCWVsc2Ugew0KCQkJCWNvbnRleHQudmlldy5oaWRlTm9NZXNzYWdlcygpOw0KCQkJfQ0KCQl9KTsNCg0KCQkvLyBjb252ZXJzYXRpb25zIGxpc3QgZW1wdHkNCgkJbWVzc2FnaW5nLnN1YnNjcmliZShtZXNzYWdlcy5jb252ZXJzYXRpb25zRW1wdHksIGZ1bmN0aW9uKGRhdGEpew0KCQkJY29udGV4dC52aWV3LnNob3dOb01lc3NhZ2VzKCk7DQoJCX0pOw0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIHN1YnNjcmliZVRvVXNlckV2ZW50cyhjb250ZXh0KSB7DQogICAgICAgIC8vIHJlc2l6ZSBsYXlvdXQgYm91bmRhcmllcyBhZnRlciBhIHdpbmRvdyBpcyBmaW5pc2hlZCBiZWluZyByZXNpemVkDQogICAgICAgIGNvbnRleHQuY29udGFpbmVyLm9uKCdyZXNpemVkJywgZnVuY3Rpb24oKXsNCiAgICAgICAgICAgIHVpLnJlc2l6ZUxheW91dChjb250ZXh0KTsNCiAgICAgICAgfSk7DQogICAgICAgIC8vIGxvYWRpbmcgb2YgY29udmVyc2F0aW9ucyB2aWEgaGFzaGNoYW5nZQ0KICAgICAgICBjb250ZXh0LmNvbnRhaW5lci5vbignaGFzaGNoYW5nZScsIGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgTW9kZWwubG9hZENvbnRleHR1YWwoY29udGV4dCk7DQogICAgICAgIH0pOw0KICAgIH0NCg0KDQoJJC50ZWxsaWdlbnQuZXZvbHV0aW9uLndpZGdldHMuY29udmVyc2F0aW9uID0gew0KCQlyZWdpc3RlcjogZnVuY3Rpb24oY29udGV4dCkgew0KICAgICAgICAgICAgLy8gY2FwdHVyZSB1aSByZWZlcmVuY2VzDQogICAgICAgICAgICBjb250ZXh0LmNvbnRhaW5lciA9ICQoZ2xvYmFsKTsNCgkJCWNvbnRleHQubWVzc2FnZUxpc3QgPSAkKGNvbnRleHQubWVzc2FnZUxpc3QpOw0KDQogICAgICAgICAgICAvLyBtb2RlbA0KICAgICAgICAgICAgY29udGV4dC5tb2RlbCA9IG5ldyBNb2RlbCh7DQogICAgICAgICAgICAgICAgbWVzc2FnZUxpc3RVcmw6IGNvbnRleHQubWVzc2FnZUxpc3RVcmwNCiAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICAvLyB2aWV3DQogICAgICAgICAgICBjb250ZXh0LnZpZXcgPSBWaWV3KHsNCiAgICAgICAgICAgICAgICB2aWV3OiBjb250ZXh0Lm1lc3NhZ2VMaXN0LA0KICAgICAgICAgICAgICAgIGNvbnRhaW5lcjogY29udGV4dC5jb250YWluZXIsDQogICAgICAgICAgICAgICAgbWVzc2FnZVJlcGx5Q29udGVudDogY29udGV4dC5tZXNzYWdlUmVwbHlDb250ZW50LA0KICAgICAgICAgICAgICAgIG1lc3NhZ2VSZXBseUNsZWFyOiBjb250ZXh0Lm1lc3NhZ2VSZXBseUNsZWFyLA0KICAgICAgICAgICAgICAgIG1lc3NhZ2VSZXBseUZvY3VzOiBjb250ZXh0Lm1lc3NhZ2VSZXBseUZvY3VzDQogICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgLy8gYmluZGluZ3MNCiAgICAgICAgICAgIHN1YnNjcmliZVRvTWVzc2FnZXMoY29udGV4dCk7DQogICAgICAgICAgICBzdWJzY3JpYmVUb1VzZXJFdmVudHMoY29udGV4dCk7DQoNCiAgICAgICAgICAgIC8vIGFkanVzdCB1aQ0KICAgICAgICAgICAgdWkuaGlkZUZvb3RlcigpOw0KICAgICAgICAgICAgdWkucmVzaXplTGF5b3V0KGNvbnRleHQpOw0KDQogICAgICAgICAgICAvLyBzdGFydA0KICAgICAgICAgICAgY29udGV4dC52aWV3LnJlbmRlcigpOw0KICAgICAgICAgICAgTW9kZWwubG9hZENvbnRleHR1YWwoY29udGV4dCk7DQoJCX0NCgl9Ow0KDQp9KShqUXVlcnksIHdpbmRvdyk7DQo=</file>
		</files>
	</scriptedContentFragment>
</scriptedContentFragments>